{% extends 'base.html' %}
{% block title %}Admin Panel{% endblock %}
{% block content %}
<section class="card admin-panel-card">
  <header class="section-header">
    <h2>Admin</h2>
    <p class="muted">Vyber, s ƒç√≠m chce≈° pracova≈•</p>
  </header>

  <div class="admin-mode-picker">
    <button class="admin-mode-btn active" data-target="articles-section">üìö Prida≈• ƒçl√°nok</button>
    <button class="admin-mode-btn" data-target="posts-section">üóëÔ∏è Spr√°va pr√≠spevkov</button>
    <button class="admin-mode-btn" data-target="users-section">üë• Profily pou≈æ√≠vateƒæov</button>
  </div>

  <div class="admin-panel-section" id="articles-section">
    <h3>Nov√Ω ƒçl√°nok</h3>
    <p class="muted">Napl≈à titulok, obsah a pridaj ilustraƒçn√Ω obr√°zok.</p>
    <form method="post" action="/admin/articles" class="admin-form" enctype="multipart/form-data">
      <label class="admin-field">
        <span>N√°zov</span>
        <input name="title" placeholder="Ako sa stara≈• o monstera deliciosa" required>
      </label>
      <label class="admin-field">
        <span>Obsah</span>
        <textarea name="content" rows="6" placeholder="Cel√Ω ƒçl√°nok..." required></textarea>
      </label>
      <div class="admin-image-group">
        <span>Obr√°zok ƒçl√°nku</span>
        <div class="admin-image-inputs">
          <label class="admin-upload">
            <span>Upload s√∫boru</span>
            <input type="file" name="image_file" id="articleImageFile" accept="image/*">
          </label>
          <label class="admin-field">
            <span>alebo extern√° URL</span>
            <input type="url" name="external_image_url" id="articleImageUrl" placeholder="https://example.com/obrazok.jpg">
          </label>
        </div>
        <div class="admin-image-preview" id="articleImagePreviewWrapper" hidden>
          <img id="articleImagePreview" alt="N√°hƒæad ƒçl√°nku">
        </div>
      </div>
      <button class="btn primary full-width">Prida≈• ƒçl√°nok</button>
    </form>
  </div>

  <div class="admin-panel-section hidden" id="posts-section">
    <h3>Spr√°va pr√≠spevkov</h3>
    <p class="muted">Vyma≈æ nevhodn√© pr√≠spevky alebo pridaj ilustraƒçn√Ω obr√°zok.</p>

    <form method="post" action="/admin/delete-post" class="admin-form">
      <label class="admin-field">
        <span>ID pr√≠spevku</span>
        <input name="post_id" placeholder="123" required>
      </label>
      <button class="btn danger">Vymaza≈• pr√≠spevok</button>
    </form>

    <div class="admin-post-list">
      {% for post in recent_posts %}
        <form method="post" action="/admin/delete-post" class="admin-post-row">
          <input type="hidden" name="post_id" value="{{ post.id }}">
          <div class="admin-post-info">
            <div class="admin-post-meta">
              <strong>#{{ post.id }}</strong>
              <span>Autor: {{ post.author }}</span>
              <span>{{ post.created_at }}</span>
            </div>
            <p>{{ post.content[:140] }}{% if post.content|length > 140 %}&hellip;{% endif %}</p>
          </div>
          <button class="btn danger small" type="submit">Vymaza≈•</button>
        </form>
      {% else %}
        <p class="muted small-text">≈Ωiadne pr√≠spevky na zobrazenie.</p>
      {% endfor %}
    </div>

    <div class="admin-divider"></div>

    <h3>Prida≈• obr√°zok k pr√≠spevku</h3>
    <form method="post" action="/admin/post-image" class="admin-form">
      <label class="admin-field">
        <span>ID pr√≠spevku</span>
        <input name="post_id" placeholder="123" required>
      </label>
      <label class="admin-field">
        <span>Cesta k obr√°zku</span>
        <input name="image_path" id="postImage" placeholder="uploads/nazov-suboru.jpg" required>
      </label>
      <button class="btn">Prida≈• obr√°zok</button>
    </form>

    <p class="muted small-text">Novinky s√∫ naƒç√≠tavan√© automaticky z NewsAPI.org.</p>
  </div>

  <div class="admin-panel-section hidden" id="users-section">
    <h3>Profily pou≈æ√≠vateƒæov</h3>
    <p class="muted">Prezri si √∫ƒçty komunity a podƒæa potreby ich vyma≈æ.</p>

    <div class="admin-post-list">
      {% for user in users %}
        <div class="admin-post-row">
          <div class="admin-post-info">
            <div class="admin-post-meta">
              <strong>@{{ user.username }}</strong>
              <span>{{ user.email }}</span>
              <span>{{ user.created_at }}</span>
            </div>
            <p class="small-text muted">{{ user.bio or '≈Ωiadny bio text.' }}</p>
          </div>
          {% if user.is_admin %}
            <span class="muted small-text">Admin</span>
          {% else %}
            <form method="post" action="/admin/delete-user">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <button class="btn danger small" type="submit">Vymaza≈•</button>
            </form>
          {% endif %}
        </div>
      {% else %}
        <p class="muted small-text">≈Ωiadni pou≈æ√≠vatelia na zobrazenie.</p>
      {% endfor %}
    </div>
    <p class="muted small-text">Admin √∫ƒçty nie je mo≈æn√© odstr√°ni≈• priamo z panelu.</p>
  </div>
</section>

<script>
const adminButtons = document.querySelectorAll('.admin-mode-btn');
const adminSections = document.querySelectorAll('.admin-panel-section');

adminButtons.forEach((btn) => {
  btn.addEventListener('click', () => {
    adminButtons.forEach(b => b.classList.toggle('active', b === btn));
    adminSections.forEach(section => {
      section.classList.toggle('hidden', section.id !== btn.dataset.target);
    });
  });
});

const articleImageFile = document.getElementById('articleImageFile');
const articleImageUrl = document.getElementById('articleImageUrl');
const previewWrapper = document.getElementById('articleImagePreviewWrapper');
const previewImage = document.getElementById('articleImagePreview');
let objectUrl = null;

function setPreview(src) {
  if (!src) {
    previewWrapper.hidden = true;
    previewImage.removeAttribute('src');
    if (objectUrl) {
      URL.revokeObjectURL(objectUrl);
      objectUrl = null;
    }
    return;
  }
  previewWrapper.hidden = false;
  previewImage.src = src;
}

if (articleImageFile) {
  articleImageFile.addEventListener('change', (event) => {
    if (objectUrl) {
      URL.revokeObjectURL(objectUrl);
      objectUrl = null;
    }
    const files = event.target.files || [];
    const file = files[0];
    if (file) {
      objectUrl = URL.createObjectURL(file);
      setPreview(objectUrl);
      if (articleImageUrl) {
        articleImageUrl.value = '';
      }
    } else {
      setPreview(null);
    }
  });
}

if (articleImageUrl) {
  articleImageUrl.addEventListener('input', (event) => {
    const value = event.target.value.trim();
    if (value) {
      setPreview(value);
      if (articleImageFile) {
        articleImageFile.value = '';
      }
    } else if (!(articleImageFile && articleImageFile.files && articleImageFile.files.length)) {
      setPreview(null);
    }
  });
}
</script>
{% endblock %}


