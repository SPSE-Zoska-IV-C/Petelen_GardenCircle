{% extends 'base.html' %}

{% block body_class %}bg-leaf{% endblock %}

{% block title %}GardenCircle ‚Äî Pr√≠spevok{% endblock %}

{% block content %}
  <section class="card post-detail-card">
    <div class="post-card">
      <div class="post-header" style="display:flex; gap: var(--space-md); align-items:center;">
        <a href="{{ url_for('user_profile', username=post.author) }}" class="post-author-link" style="text-decoration:none; display:flex; align-items:center; gap: var(--space-sm);">
          <div class="post-author-avatar">
            {% if post.author_image %}
              {% if post.author_image.startswith('http') %}
                <img src="{{ post.author_image }}" alt="{{ post.author }}" loading="lazy">
              {% else %}
                <img src="{{ url_for('static', filename=post.author_image) }}" alt="{{ post.author }}" loading="lazy">
              {% endif %}
            {% else %}
              <div class="avatar-placeholder-small">{{ post.author[0].upper() }}</div>
            {% endif %}
          </div>
          <div class="meta">
            <strong class="author">{{ post.author }}</strong>
            <time class="time">{{ post.created_at }}</time>
          </div>
        </a>
      </div>
      <div class="post-content">
        {{ post.content }}
      </div>
      {% if post.image_path %}
        <img src="{{ url_for('static', filename=post.image_path) }}" alt="Obr√°zok pr√≠spevku" loading="lazy">
      {% endif %}
      <div class="post-actions" style="display:flex; align-items:center; gap:.5rem; margin-top:.5rem;">
        <button id="likeBtn" class="btn btn-ghost like-btn {{ 'liked' if post.liked else '' }}" data-post-id="{{ post.id }}" aria-label="P√°ƒçi sa mi to">
          <span class="like-emoji">{{ '‚ù§Ô∏è' if post.liked else 'ü§ç' }}</span>
        </button>
        <span id="likeCount" class="like-count">{{ post.like_count or 0 }}</span>
      </div>
    </div>

    <div class="comment-section-inline">
      <header class="section-header" style="display:flex; flex-wrap:wrap; align-items:center; gap:var(--space-md); justify-content:space-between;">
        <div>
          <h2>Koment√°re</h2>
          <p class="muted">ƒåo si o tom mysl√≠≈°?</p>
        </div>
        <div class="auto-answer-controls">
          <button type="button" class="btn btn-ghost small" id="autoAnswerToggle" aria-haspopup="true" aria-expanded="false">ü§ñ Z√≠ska≈• AI odpoveƒè</button>
          <div id="autoAnswerMenu" class="auto-answer-menu" hidden>
            <button type="button" class="btn btn-ghost small auto-answer-option" data-length="short" data-post-id="{{ post.id }}">‚ö° Kr√°tka odpoveƒè</button>
            <button type="button" class="btn btn-ghost small auto-answer-option" data-length="long" data-post-id="{{ post.id }}">üìö Dlh≈°ia odpoveƒè</button>
          </div>
          <span class="muted small-text" id="autoAnswerStatus" hidden>Vyber dƒ∫≈æku odpovede.</span>
        </div>
      </header>

      <div id="aiAnswerPreview" class="card" style="display:none; margin-top: var(--space-md); padding: var(--space-lg);">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap: var(--space-md);">
          <div style="min-width:0;">
            <strong>ü§ñ AI odpoveƒè (iba pre teba)</strong>
            <div class="muted" style="margin-top: var(--space-xs);">T√°to odpoveƒè sa neulo≈æ√≠ do koment√°rov.</div>
          </div>
          <button type="button" class="btn btn-ghost small" id="aiAnswerDismiss" aria-label="Skry≈• AI odpoveƒè">‚úï</button>
        </div>
        <div id="aiAnswerText" style="margin-top: var(--space-md); white-space: pre-wrap;"></div>
      </div>
      
      <ul class="comment-list">
        {% for c in comments %}
          <li>
            <div style="display:flex; gap: var(--space-sm); align-items:flex-start;">
              <a href="{{ url_for('user_profile', username=c.author) if c.author_id else '#' }}" style="text-decoration:none;">
                <div class="post-author-avatar" style="width:44px; height:44px;">
                  {% if c.author_image %}
                    {% if c.author_image.startswith('http') %}
                      <img src="{{ c.author_image }}" alt="{{ c.author }}" loading="lazy">
                    {% else %}
                      <img src="{{ url_for('static', filename=c.author_image) }}" alt="{{ c.author }}" loading="lazy">
                    {% endif %}
                  {% else %}
                    <div class="avatar-placeholder-small">{{ c.author[0].upper() }}</div>
                  {% endif %}
                </div>
              </a>
              <div style="min-width:0; flex:1;">
                <a href="{{ url_for('user_profile', username=c.author) if c.author_id else '#' }}" style="text-decoration:none;">
                  <strong>{{ c.author }}</strong>
                </a>
                <span class="muted"> ‚Ä¢ {{ c.created_at }}</span>
                <div style="margin-top: var(--space-xs);">{{ c.text }}</div>
              </div>
            </div>
          </li>
        {% else %}
          <li class="muted text-center" style="padding: var(--space-lg);">
            Zatiaƒæ ≈æiadne koment√°re ‚Äî buƒè prv√Ω, kto komentuje!
          </li>
        {% endfor %}
      </ul>

      <form class="comment-form" method="post" action="{{ url_for('add_comment', post_id=post.id) }}">
        <div class="form-group" style="width:100%;">
          <textarea class="comment-input comment-textarea" name="text" placeholder="Nap√≠≈° koment√°r..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Odosla≈• koment√°r</button>
      </form>
    </div>
  </section>

  <script>
    const autoAnswerToggle = document.getElementById('autoAnswerToggle');
    const autoAnswerMenu = document.getElementById('autoAnswerMenu');
    const autoAnswerStatus = document.getElementById('autoAnswerStatus');
    const commentList = document.querySelector('.comment-list');
    const aiAnswerPreview = document.getElementById('aiAnswerPreview');
    const aiAnswerText = document.getElementById('aiAnswerText');
    const aiAnswerDismiss = document.getElementById('aiAnswerDismiss');

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.innerText = text;
      return div.innerHTML;
    }

    function showAiPreview(author, text) {
      if (!aiAnswerPreview || !aiAnswerText) return;
      aiAnswerText.innerHTML = `<strong>${escapeHtml(author)}</strong><div style="margin-top: var(--space-xs);">${escapeHtml(text)}</div>`;
      aiAnswerPreview.style.display = 'block';
      aiAnswerPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideAiPreview() {
      if (!aiAnswerPreview || !aiAnswerText) return;
      aiAnswerText.textContent = '';
      aiAnswerPreview.style.display = 'none';
    }

    function setStatus(message, show = true) {
      if (!autoAnswerStatus) return;
      autoAnswerStatus.textContent = message;
      autoAnswerStatus.hidden = !show;
    }

    function openAnswerMenu() {
      if (!autoAnswerMenu || !autoAnswerToggle) return;
      autoAnswerMenu.hidden = false;
      autoAnswerMenu.dataset.open = 'true';
      autoAnswerToggle.setAttribute('aria-expanded', 'true');
      setStatus('Vyber dƒ∫≈æku odpovede.', true);
    }

    function closeAnswerMenu() {
      if (!autoAnswerMenu || !autoAnswerToggle) return;
      autoAnswerMenu.hidden = true;
      autoAnswerMenu.dataset.open = 'false';
      autoAnswerToggle.setAttribute('aria-expanded', 'false');
    }

    async function requestAutoAnswer(postId, length, triggerBtn) {
      if (triggerBtn) {
        triggerBtn.disabled = true;
      }
      if (autoAnswerToggle) {
        autoAnswerToggle.disabled = true;
      }
      setStatus('AI spracov√°va odpoveƒè‚Ä¶');

      try {
        const response = await fetch(`/api/posts/${postId}/answer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ length })
        });
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Nepodarilo sa naƒç√≠ta≈• odpoveƒè.');
        }

        showAiPreview(data.author || 'GardenCircle Guide', data.text || '');
        setStatus('Odpoveƒè AI bola zobrazen√° (neuklad√° sa).');
        closeAnswerMenu();
      } catch (error) {
        console.error(error);
        setStatus(error.message || 'AI odpoveƒè sa nepodarila.');
      } finally {
        if (triggerBtn) {
          triggerBtn.disabled = false;
        }
        if (autoAnswerToggle) {
          autoAnswerToggle.disabled = false;
        }
      }
    }

    if (autoAnswerToggle && autoAnswerMenu) {
      autoAnswerToggle.addEventListener('click', () => {
        if (autoAnswerMenu.hidden) {
          openAnswerMenu();
        } else {
          closeAnswerMenu();
        }
      });

      document.addEventListener('click', (event) => {
        if (autoAnswerMenu.hidden) return;
        const target = event.target;
        if (!autoAnswerMenu.contains(target) && target !== autoAnswerToggle) {
          closeAnswerMenu();
          setStatus('', false);
        }
      });

      autoAnswerMenu.querySelectorAll('.auto-answer-option').forEach((btn) => {
        btn.addEventListener('click', () => {
          const length = btn.dataset.length || 'short';
          const postId = btn.dataset.postId;
          requestAutoAnswer(postId, length, btn);
        });
      });
    }

    if (aiAnswerDismiss) {
      aiAnswerDismiss.addEventListener('click', hideAiPreview);
    }
  </script>
{% endblock %}